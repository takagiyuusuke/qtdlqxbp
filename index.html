<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>太陽観測ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/fitsjs@0.6.0/dist/fits.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
      background: #f0f8ff;
    }
    h2 {
      margin-top: 2rem;
    }
    #aia-images {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin-top: 1rem;
    }
    .aia-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 1px solid #ccc;
    }
    .wavelength-label {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>🌞 太陽観測ダッシュボード 🌞</h1>

  <h2>HMI 太陽画像（12時間前）</h2>
  <p id="hmi-time"></p>
  <img id="hmi-image" width="512" alt="HMI Image">

  <h2>AIA 太陽画像（10日前・9波長）</h2>
  <p id="aia-time"></p>
  <div id="aia-images"></div>

  <script>
    // AIA 9波長のコード
    const aiaWavelengths = [
      "0094", "0131", "0171", "0193", "0211",
      "0304", "0335", "1600", "1700"
    ];

    // 日時をフォーマットする関数
    function formatDate(date) {
      const YYYY = date.getFullYear();
      const MM = String(date.getMonth() + 1).padStart(2, '0');
      const DD = String(date.getDate()).padStart(2, '0');
      const HH = String(date.getHours()).padStart(2, '0');
      return { YYYY, MM, DD, HH };
    }

    // HMI画像を表示
    function displayHMI() {
      const now = new Date();
      now.setHours(now.getHours() - 12);
      now.setMinutes(0, 0, 0);
      const { YYYY, MM, DD, HH } = formatDate(now);
      const url = `https://jsoc1.stanford.edu/data/hmi/images/${YYYY}/${MM}/${DD}/${YYYY}${MM}${DD}_${HH}0000_M_1k.jpg`;
      document.getElementById("hmi-image").src = url;
      document.getElementById("hmi-time").textContent = `取得時刻：${now.toLocaleString()}`;
    }

    // AIA画像を表示
    async function displayAIA() {
      const now = new Date();
      now.setDate(now.getDate() - 10);
      now.setMinutes(0, 0, 0);
      const { YYYY, MM, DD, HH } = formatDate(now);

      const aiaTimeStr = now.toLocaleString();
      document.getElementById("aia-time").textContent = `取得時刻：${aiaTimeStr}`;

      for (const wave of aiaWavelengths) {
        const url = `https://jsoc1.stanford.edu/data/aia/synoptic/${YYYY}/${MM}/${DD}/H${HH}00/AIA${YYYY}${MM}${DD}_${HH}00_${wave}.fits`;

        try {
          const response = await fetch(url);
          const arrayBuffer = await response.arrayBuffer();
          const fits = new astro.FITS(arrayBuffer);
          const hdu = fits.getHDU();
          const image = hdu.data;
          const width = image.width;
          const height = image.height;
          const data = image.data;

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          const imgData = ctx.createImageData(width, height);

          const min = Math.min(...data);
          const max = Math.max(...data);

          for (let i = 0; i < data.length; i++) {
            const norm = (data[i] - min) / (max - min);
            const value = Math.floor(norm * 255);
            imgData.data[i * 4 + 0] = value;
            imgData.data[i * 4 + 1] = value;
            imgData.data[i * 4 + 2] = value;
            imgData.data[i * 4 + 3] = 255;
          }

          ctx.putImageData(imgData, 0, 0);

          const container = document.createElement("div");
          container.className = "aia-container";
          const label = document.createElement("div");
          label.className = "wavelength-label";
          label.textContent = `${wave} Å`;
          container.appendChild(canvas);
          container.appendChild(label);

          document.getElementById("aia-images").appendChild(container);
        } catch (err) {
          console.warn(`AIA波長 ${wave} 読み込み失敗:`, err);
        }
      }
    }

    // 実行！
    displayHMI();
    displayAIA();
  </script>
</body>
</html>
